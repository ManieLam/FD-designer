

# 表单模型

1. 从布局上：常规流式、网格、多栏、表格、多字段区域组合
2. 从数据上：
   - 根据路由参数/其他表单带入的需要在起初发起请求获取数据 （编辑、步骤）
   - 无默认数据表单，简单增删改，数据提交，再跳转到指定位置 （问卷）

# 画布

# 对配置文件的考虑
```

```

## 预览
1. 拼接完的代码页面预览？直接页面效果预览？
2. 从配置json中抽取信息
3. mounted 封装 --- 哪些是需要在表单首次加载完成的：默认值填充、发起加载请求、relation默认加载 （目前数据请求跨域问题，暂时使用mock，但是实际在项目中使用时，需要考虑）；如何获取配置的所有数据源？ 【ok】
4. 表单其他行为执行
5. 校验封装
6. 联动触发、行为触发

### 直接预览页面效果
> 
> 输入：config.json；输出：.vue文件
>
> 事件处理 - mounted封装【表单初始化时的行为执行】；联动效果处理；请求模拟数据、模拟填值状态；
> 
> 属性处理 - form属性、form-item属性 转换为anso-ui/ansoDataform 支持的配置
> > 校验：rules<Object\>转为rules<Array\>；
> >
> > 选项：根据optionType类型选择options/optionsAsyncFunc赋值；存在异步取值
> >
> > 默认值：根据defaultValue.valueType取值；如果valueType==='isPreset'则为默认取值
> >
> > 搜索：根据filterAbleType类型选择, 存在异步搜索
> 
> 增加表单子组件类型，有相应新的属性需要转换，需要在预览中增加解译操作

### 导出文件
- json配置文件
- vue文件
- html文件

### 编译/使用

#### 用于二次开发
  > 首先获取配置文件：导出的.json文件（多个，一个画布相当于一个组件）
 * 使用方法一（TODO）：install -- 搭配main.js中vue.use()
 * 使用方法二：全局异步注册模板组件 + 使用
  ``` js
   // 步骤一：main.js
   import { registerModules } from 'FDTranslator'
   registerModules(Vue)
   // 步骤二：实际应用的项目页面
   import { templateRegister } from 'FDTranslator'
    // 调用配置文件（略）
    // 获取模板组件
   this.compName = templateRegister[配置.template]
    // 使用动态组件加载
   component(:is="compName", :config="配置")

   // TODO 还需要对工具方法/类的转出？
  ```

​	TODO 需要默认加载一些utils工具函数



 * 使用方法三（TODO）：路由() => import(''), 直接引入使用
 * 使用方法四（TODO）：Vue.compile( template ) 渲染模板

  > 导出.vue文件，直接按需使用

#### 直接使用
> 导出 .html/.js 文件（多个, 一个画布一个文件）

- 利用blob数据转换，生成html对象
- 单独指定文件打包

------
# 全局配置
## 数据源配置
1. 请求地址 🆗

2. 请求方式
   - 手动配置 🆗
   - 全局导入 TODO 

3. 请求头部
     - 手动配置 🆗
     - 全局导入 TODO 
4. 请求参数
     - 动态数据源 获取指定参数（表单数据/路由数据/本地缓存） = 当body中变量类型value存在`${row.varType}|${row.value}`这个格式 需要转换成动态取值 🆗
     - 地址栏动态参数配置，如：http://localhost:11011/api/area/23/user/1111111?orgin=123&timeStamp=1668495558905，其中【23，11111】为动态参数，在配置中显示为：http://localhost:11011/api/area/${area}/user/${userCode}?orgin=123&timeStamp=1668495558905。其中${area}和${userCode}需要在【请求参数(path)】中配置指定的数据源 🆗
     - 地址栏中出现【${}】的符号，则动态在【请求参数(path)】中对应生成参数行。
     - 全局导入 TODO
5. 数据处理 提交前
     - 动态数据源 请求参数自定义 🆗

6. 数据处理 数据返回数据响应时
     - 自定义 🆗
     - 当修改响应返回的数据格式，赋值问题需要处理 （TODO）
7. 数据处理 异常数据处理
     - 自定义 🆗
8. 备注
9. 全局导入数据源
     - 开放导入 TODO
     - 模拟导入 🆗

10. 测试链接
     - 弹窗显示测试结果 TODO （目前直接在控制台查看） 
11. 多数据源配置

     - 方式：并行 ok, 串行 ok, xx条件执行A、xx条件执行B (TODO)
     - 条件：
          ```
          根据返回的请求数据？一般A接口返回的数据作为B发起的参数，成立吗，那直接将A的请求参数放到B发起时候带过去，不就可以？场景：
               A1 -> A1 === 1 ? B1 : B2
               A2 -> A2 ===2 && A1 === 1 ? B1 : B2
               A1 满足再次发起条件 ？ 执行B1 ：关闭请求 ---- 下一步操作者/判断业务是否有锁定，未锁定业务可以办理

          设置表单默认数据源? 将请求回来的数据参数分组成表单的多份数据集合，在配置默认值的时候，通过【数据集合名.字段名】的方式设置 --- 接口必须设置name,用于标识数据集合，【name唯一性】
          ```
     - 请求参数 修改为 指定接口的取值
       - 指定接口范围：
         - 初始化请求的接口; 🆗 
         - 已配置的提交接口; ok
         - 分步骤表单，还需要支持上一个表单的数据集合; TODO (待分步骤表单开发出来后再做, 对应的场景: 拆表第3个动作输入x,在第4个动作,需要获取到x填入到文本框)
     - 禁止修改返回格式 TODO
     - 默认值，根据多数据源，赋值修改为可以指定数据集合中的字段 🆗
     - 指定默认数据集合，默认第一个为系统默认，可自定义切换默认，当默认数据源被移除，自动补位下一个接口为默认数据集 🆗
     - 新增、编辑、删除接口 🆗
       - 0到1：选中全局、自添加
       - 1到n:（单数据源也适用）
         - 从全局中选中，修改为自定义，全局中不出现√  --- 修改为自定义，即修改为当前接口，不属于全局接口，除非保存全局
         - 从自定义改为全局，全局中重新出现√ 
       - n到0：
         - 恢复添加按钮，数据为空
     - 批量操作
       - 一次性多选 TODO (版本三)
       - 一次性创建多个（创建完当前继续不关闭弹窗继续添加）🆗


12 数据源选择器/编辑器,操作说明
     - 从左侧选中全局接口, 在右侧编辑, 编辑之后, 可选择[确定选中],即保存到当前, 不影响到全局(满足从全局中对类似的接口进行复制修改); 选择[保存至全局],即对当前选中的全局接口做修改,更新全局的接口列表. 
     - 从左侧选中全局接口, 在右侧编辑, 是复制的性质, 在未[保存至全局]时, 都不属于全局接口.

1.  提交事件 - 根据多数据源配置优化
    - 场景1：需要支持画布间的提交交互（包括表单参数间传递）TODO 迭代三(待多画布/更多表单效果再开发)
    - 场景2/场景3：提交需要支持并联、串联，支持多数据源情形 🆗
    - 场景4：第三步的某字段relation，配置为数据接口，参数问题需要处理。（参数需要支持跨表单读取，即场景1）

## 组件拖拽
1. 拖拽顺序 - 需要默认追尾: 已完成随意拖拽存放的位置，不做默认追尾。
2. 拖拽过程的取消拖拽 TODO

--------
# 表单配置
## 属性
1. 只读 ok
2. 表单标题 TODO
3. 布局类型 TODO
4. 文本标签宽度 ok
5. 文本显示位置 ok
6. 保留数据输入/缓存数据 TODO
7. 自动聚焦 TODO
8. 回车提交表单 TODO

## 行为
1. 初始化时加载字段字典

     - 配置数据源
     - 
2. 获取初始化数据

     - 前置触发条件 TODO

     - 配置数据源 🆗

     - 数据获取后赋值操作 🆗

     - 动态数据源 带定值参数/请求参数自定义 🆗

     - 动态数据源 获取指定参数（表单数据/路由数据/本地缓存） 🆗

     - TODO 修改数据源，同步修改配置该数据源的相关参数

3. 提交按钮

     - 提交前校验 🆗
     - 提交前数据处理
     - 提交后操作 通过emit通知外部 🆗
     - 提交事件 可配置/规则设计 TODO
     - 
4. 取消按钮

     - 取消前二次提醒 🆗 （TODO: bug 弹窗层级问题）
     - 关闭弹窗 🆗
     - 返回上一页 🆗
     - 
5. 重置按钮

     - 重置前二次提醒 🆗

     - 清空数据 🆗

6. 自定义按钮 TODO

--------

# 组件配置
## select
### 选项
1. 手动添加 🆗
2. 动态字典 🆗
3. 动态数据源
     - 配置/解译 🆗

### 分组（TODO）
1. 支持的分组方式：anso-ui 支持根据选项中某个属性值分组

2. 自定义分组名称

### 多选 （TODO）
1. 数据结构问题处理，单选时候需要String或Number，多选时候，需要允许Array
2. 
### 搜索
1. 静态搜索 🆗
2. 远程搜索

     - 配置 🆗

     - 解译 （TODO），涉及在原先组件的基础上无法实现 

### 验证
1. 选中任何种校验规则，都允许各自配置，并写入storage
2. 可以多选规则
3. 点击保存+刷新，同步与视图区数据交互
4. 自定义规则String转换Function，并成功运行

### 默认值
1. 默认配置同名取值，可以在请求数据后，自动赋值 🆗
2. 配置指定localstorage的名称，暂不支持取值为对象类型，取值后能成功赋值 🆗
3. 指定获取地址栏数据，自动赋值 🆗
4. 指定根据表单内数据自定义运算　🆗
5. 指定关联字段及配置的相关行为　
6. 选择预设常规的默认值 🆗
7. 指定数据源, 再+以上操作 🆗
   
> props:
> >  value：defaultValue --- 实际数值
> >  valueType：defaultValueType --- 默认取值类型
> >  presetType: ---- 预设数据可选项

### 联动交互
> 基本操作场景: 
>    场景1: 某个字段修改, 带动其他1或者n个字段, 选项改变、数值改变、校验规则改变....(属性改变) /默认值改变/发起请求
>    场景2: 异步请求触发, 某1个或者n个字段, 属性改变/默认值改变
>    场景3: 表单间/区域间异步联动, 表单A某字段值改变, 触发表单B, 1-n个字段修改
>    场景4: 某个字段选中, 触发弹窗
>    
> 
1. 触发对象
2. 触发事件
3. 触发后执行事务

### 手写代码
  - 选项
  - 配置数据源
  - 配置默认值（可由表单配置中的【初始化-发起请求】中处理；暂时不做解译）
    ```
    (data, fields, field) => {
      // 一般参与计算的有：fields[field.name].options、data[某个字段]
      return data[field.name]
    }
    ```

-------------
# 数据接口常用格式
至少返回层级到code、message、data
```
- 列表/relation:
{
  code: 0,
  message: '',
  data: {
    data: [{ name: 'relation字典名称', desc: '' }],
    total: 1
  }
}

- 新增/编辑/删除，结果返回
{
  code: 0,
  message: '',
  data: null
}

- 详情
{
  code: 0,
  message: '',
  data: {} // data中不嵌套列表或者其他
}

- code数据范围：0, -1, 6

// TODO 不同的返回格式，需要在配置中定义，现在用的是通用格式（@/model/resource.js）。

```


-------------

# 在线预览
- 发布在线预览，提示输入路由页面名称，数据上传服务端
- 新建vue页面，可props和get服务端配置数据，引用Template模板组件，新建并打开新页面路由
- 弹窗显示成功/失败信息窗，成功则显示新页面地址，方便复制
- 窗口间数据通信:
  - 数据源请求接口头部/参数,可以通过配置设置
  - 窗口间postMessage(弹窗关闭: window.parent.postMessage('onCloseDialog', '*')) 

TODO　ace的访问,现在是做成cdn, 在线预览的页面与配置页面是同个环境, 受到ace调用影响会打不开页面, 而且ace是与预览页面无关的, 在预览的时候是不需要访问的.

TODO 请求结束的通知,注意不是执行成功/失败通知 (不一定做)
```
this.$emit('onMultiRequireEnd', reqRes)
window.parent.postMessage({ onMultiRequireEnd: reqRes })
// 串联请求失败
window.parent.postMessage({ onSeriesRequireFalse: api })
```

TODO 防止重复发布, 支持修改

```
上传接口
10.0.60.34:18090
http://192.168.0.210:20411/api/fileserver/upload
保存json
http://192.168.0.210:20411/api/fileserver/ui/config/save
{"config": ""}
编辑json
http://192.168.0.210:20411/api/fileserver/ui/config/edit/{id}
{"config": ""}
获取json
http://192.168.0.210:20411/api/fileserver/ui/config/get/{id}
{"code": 1, "message": "", "data": {"id": 1, "config": ""}}

https://juejin.cn/post/6876751431374929934
```

TODO nginx.conf 配置(多套数据环境情况, 配置环境的问题)
```
server {
     listen       8000;
     server_name  localhost;

     #charset koi8-r;

     #access_log  logs/host.access.log  main;
     location /api {
          proxy_pass http://0.0.0.0:4523/m1/1812979-0-default;  #代理的域名暂时是我的本地环境,之后切换成各个业务环境
          add_header 'Access-Control-Allow-Origin' '*'; 
          add_header 'Access-Control-Allow-Credentials' 'true'; 
     }
     location  /fileserver {   # 配置服务地址:http://10.0.60.34:18090
          root   /var/www/vue/;
          index  index.html index.htm;
     }
}

```

# 环境配置
- 如果输入的 URL 不是以http://或https://起始，实际发出请求的时候会自动加上当前环境里前置 URL。
- 当前环境 配置内容：
  - 环境名称
  - 环境服务： 前置URL
  - 环境变量？

- 环境与服务区别
```
环境：
  开发环境
  测试环境
  预发布环境
  正式环境

服务：
  用户服务（user.xxx.com）：登录等接口
  交易服务（trade.xxx.com）：交易相关接口
  直播服务（live.xxx.com）：直播相关接口
```

# h5接入
1. 接入模式（发布在线服务）：配置服务环境、在线预览服务、发布(人工导出+引用组件+打包发布到在线预览环境？一键发布？即在当前配置服务环境中新开路由页面供调用) 🆗
2. h5接入
   父级/前后端通信 - 动态token问题 🆗
  有带需要获取移动设备服务的需求/实时code： 微信端用户授权相关信息 -> 在线服务 -> 在线服务提交后端服务
  在线服务get后端服务详情 -> 在线服务提交后端

4. 添加录入组件（upload、cascader、switch、Date、Time、TimeRange）
   - 组件补充
     > 1. 不仅基于ansoUi的录入组件库, 涉及一些移动端的组件, 原计划只是基于ansoui做的录入库需要扩展修改
     > 2. 这样还能不能直接使用ansoformItem??? 涉及ansoFormBody的设计
# 表单其他格式支持
1. 网格布局属性: 行/列数; 设置方向；多行多列，跨多行跨多列; border=false，关闭边框
2. 栅格布局属性: 可收缩/展开；设置最大行；表单默认的列数；是否自适应屏幕的列数；表单行内跨列
>
> 问题：
> 1.画布区域是单独一套widgetForm还是直接用ansoDataform？

     > 用方法1(独立做)则有以下问题：1） 样式与ansoDataform必须保持一致，如果改用新的一套的话，就需要沿用原先的样式类名，但是由于html嵌套层级的改动，有些类名可能不存在，所以导致对该类名的修改会失效，包括其他产品项目如果有用到的话，也会无效；2）ansoDataform中的grid样式和row样式都是单独组件形式，不单单样式可以处理，比如跨列跨行的单元格计算、自适应列数等功能。

     > 用方法2（使用ansoDataform或ansoFormBody）的则有以下问题：1) 在配置的过程中经常需要转换成columns的形式，受ansoDataform属性传输限制，需要对扁平的属性结构进行封装form: {}的格式，并且属性名称需一致，即将预览的功能放在这里展示。一方面影响配置的效率，另一方面与预览功能的重复；2）所有扩展的组件都需要依赖组件库，包括后续添加的组件都需要先在组件库补充；3）ansoDataform不支持内部录入组件的拖拽，需要改组件库或者每个字段都用slot去替换。
>



# 问题/TODO
1. 手填的一些属性值没有数据格式限定
2. 增加表单内字段分组的概念 ---- 分组名称、分组排序
3. 增加表单按钮配置属性 --- 按钮数量、单按钮属性、位置
4. 增加表单底部自定义、顶部自定义，选中则在左边高亮显示区域？
5. 切换【组件/表单配置区】希望左边能显示高亮 ok
6. 插槽的开放，允许插入自定义组件
7. 接口参数命名规则: 目前纠结2种方案, 方案一: 记录url+method拼接的命名做key, url和method相同即认为是同一个接口, 一旦保存全局, 则会替换原先接口; 方案二: 采取时间戳做key记录, 什么时候改变key值就成了问题,从全局中选中,是属于编辑该全局接口信息,可以分别选中[确定选中]还是[保存至全局]来决定是否修改原全局参数, 当url和method与选中数据源不一致,则修改name和__global,认为非全局参数
8. 前后缀, 支持自定义组件
9. 数据源返回的数据中，获取深层数据属性，即数据源返回的是{a: {a1, a2}}, 取a1
10. 需要列配置行为等级，哪些行为属于该设计器支持范围，当超出这个范围，需要前端人员再二次开发
11. 代码编辑安全性
--------------
# 总结
> 第二迭代：
>    迭代二增加的多数据源配置、数据源参数配置交互调整，增加自动生成参数、数据源配置器概念调整，默认值调整允许指定不同数据源；
>    在第三迭代，计划对数据源配置增加一些新修改：分步骤的串联数据提交交互、一次性多选数据、禁止修改数据返回的格式等；
>
> 

# 场景演示
1. 提交数据 - 动态数据源 获取指定参数（表单数据）
2. 增加Text和input类型的组件
3. 取消按钮，分关闭页面/分关闭弹窗 ok
4. 

----
# 其他类似概念的低代码搭建平台
1. 百度 - 爱速搭（商用需要收费）、[amis](https://baidu.github.io/amis/zh-CN/docs/index) - 基于react开发，如产品项目需要二次开发需要使用react，[关于vue的使用](https://github.com/baidu/amis/issues/31)
2. jeecgBoot（包含前后端+搭建工具 - 收费）

# 代码编辑器
1. monaco-editor


# 技术栈
https://www.npmjs.com/package/eventemitter2
iframe嵌入通信：postMessage


